generator client {
provider = "prisma-client-js"
}


datasource db {
provider = "postgresql"
url = env("DATABASE_URL")
}


model User {
id String @id @default(cuid())
email String @unique
password String
role Role @default(USER)
sessions Session[]
keys Key[]
passwordResetTokens PasswordResetToken[]
keyQueries KeyQuery[]
createdAt DateTime @default(now())
updatedAt DateTime @updatedAt
}


enum Role {
USER
ADMIN
}


model Session {
id String @id @default(cuid())
userId String
user User @relation(fields: [userId], references: [id], onDelete: Cascade)
expiration DateTime
createdAt DateTime @default(now())
}


model PasswordResetToken {
  id String @id @default(cuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String @unique
  expiresAt DateTime
  used Boolean @default(false)
  createdAt DateTime @default(now())
}

model Key {
  id String @id @default(cuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  name String
  description String?
  unit String? // Unidad opcional
  door String? // Puerta opcional
  notes String? // Notas opcionales
  imageUrl String? // URL de la imagen en Cloudinary
  imagePublicId String? // Public ID de Cloudinary para gestión
  signature Json? // Vector de características (legacy)
  sigStatus String @default("pending") // 'pending' | 'ready' | 'failed'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // New multimodal signatures
  signatures KeySignature[]
  
  @@map("keys")
}

// New table for multimodal key signatures
model KeySignature {
  id String @id @default(cuid())
  
  // Relation to key (inventory)
  keyId String?
  key Key? @relation(fields: [keyId], references: [id], onDelete: Cascade)
  
  // Relation to key query (identification)
  keyQueryId String?
  keyQuery KeyQuery? @relation(fields: [keyQueryId], references: [id], onDelete: Cascade)
  
  // AI-generated signature data
  signature Json // Structured JSON from GPT-4o
  imageUrl String? // URL of the analyzed image
  confidenceScore Float? // AI confidence score
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("key_signatures")
}

// New table for key identification queries
model KeyQuery {
  id String @id @default(cuid())
  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Query details
  queryType String // "identification" | "comparison"
  result Json // Query result data
  status String @default("pending") // "pending" | "completed" | "failed"
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  signatures KeySignature[]
  
  @@map("key_queries")
}

